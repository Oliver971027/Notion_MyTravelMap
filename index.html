<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>My Travel Map (Final Fixed)</title>
<style>
  /* 1. 絕對滿版設定 */
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #E1F5FE; /* 海洋底色 */
  }

  /* 2. 圖表容器 */
  #chartdiv {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  /* 3. 左上角訊息視窗 */
  #debug-console {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #00ff00;
    font-family: monospace, sans-serif;
    font-size: 14px;
    padding: 10px 15px;
    border-radius: 5px;
    z-index: 9999;
    pointer-events: none;
    max-width: 300px;
    transition: opacity 0.5s;
  }
</style>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldHigh.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

</head>
<body>

<div id="debug-console">系統啟動中...</div>
<div id="chartdiv"></div>

<script>
  // === 訊息顯示工具 ===
  const debugDiv = document.getElementById('debug-console');
  
  function showStatus(msg) {
    debugDiv.innerHTML = "SYSTEM > " + msg;
    debugDiv.style.color = "#00ff00";
  }
  
  function showError(msg) {
    debugDiv.innerHTML = "[ERROR] > " + msg;
    debugDiv.style.color = "#ff4444";
    debugDiv.style.backgroundColor = "rgba(50, 0, 0, 0.9)";
  }

  am5.ready(function() {
    showStatus("載入 amCharts 核心...");

    // ==========================================
    // 設定區
    // ==========================================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfNBKFYRbs8r4NoYBSFFrx7K87vdvlhXcmQcnR9PbZED4BSyYadZENz4fPU4e4bes5JyTQRfrctWKD/pub?gid=0&single=true&output=csv";
    const HOME_ID = "TW";
    
    // 初始位置
    const INITIAL_LONGITUDE = 120.9;
    const INITIAL_LATITUDE = 23.6;

    // 1. 建立 Root
    var root = am5.Root.new("chartdiv");
    root.setThemes([am5themes_Animated.new(root)]);

    // 2. 建立地圖
    showStatus("建立地圖物件 (High Res)...");
    
    var chart = root.container.children.push(am5map.MapChart.new(root, {
      panX: "rotateX",       
      panY: "translateY",    
      minZoomLevel: 1,       
      maxZoomLevel: 64,
      
      homeGeoPoint: { latitude: INITIAL_LATITUDE, longitude: INITIAL_LONGITUDE },
      homeZoomLevel: 1,

      paddingLeft: 0, paddingRight: 0, paddingTop: 0, paddingBottom: 0
    }));

    // 3. 建立多邊形 (使用 worldHigh)
    var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
      geoJSON: am5geodata_worldHigh, 
      exclude: ["AQ"] 
    }));

    // 4. 顏色定義
    const colors = {
      unvisited: { fill: am5.color(0xD1D1D1), hover: am5.color(0xA9A9A9) }, 
      visited:   { fill: am5.color(0xC8E6C9), hover: am5.color(0x66BB6A) }, 
      home:      { fill: am5.color(0xFFC107), hover: am5.color(0xFF8F00) }  
    };

    // 5. 設定樣式
    polygonSeries.mapPolygons.template.setAll({
      tooltipText: "{name}",
      // [關鍵修正] 移除了 toggleKey: "active"
      // 這會防止點擊後國家變成「選取狀態」而導致卡住
      interactive: true,
      fill: colors.unvisited.fill, 
      stroke: am5.color(0xffffff),
      strokeWidth: 0.5,
      templateField: "polygonSettings"
    });

    // 顏色 Adapter
    polygonSeries.mapPolygons.template.adapters.add("fill", function(fill, target) {
      if (target.dataItem && target.dataItem.dataContext) {
        if (target.isHover()) {
          return target.dataItem.dataContext.hoverColor || colors.unvisited.hover;
        }
        return target.dataItem.dataContext.fill || fill;
      }
      return fill;
    });

    // 游標 Adapter：只有「有網址」的國家才顯示手指游標
    polygonSeries.mapPolygons.template.adapters.add("cursorOverStyle", function(style, target) {
      return target.dataItem.dataContext.url ? "pointer" : "default";
    });

    // 點擊事件
    polygonSeries.mapPolygons.template.events.on("click", function(ev) {
      var data = ev.target.dataItem.dataContext;
      
      // [關鍵修正] 嚴格判斷
      // 如果沒有 url，直接 return (結束)，什麼都不做，防止任何縮放或卡住
      if (!data.url || data.url.trim() === "") {
        return; 
      }

      // 只有有網址才會執行到這裡
      window.open(data.url, '_blank');
    });

    // 6. 資料讀取
    async function loadMapData() {
      showStatus("正在連線 Google Sheets...");
      
      let mapData = [];
      mapData.push({ id: HOME_ID, fill: colors.home.fill, hoverColor: colors.home.hover });
      polygonSeries.data.setAll(mapData);

      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error("HTTP " + response.status);
        
        showStatus("資料下載成功，解析中...");
        const csvText = await response.text();
        const rows = csvText.split(/\r?\n/).slice(1);
        
        rows.forEach(row => {
          const cols = row.split(",");
          if (cols.length >= 1) {
            const cid = cols[0].trim();
            const url = cols[1] ? cols[1].trim() : "";
            if (cid && cid !== HOME_ID) {
              mapData.push({
                id: cid,
                fill: colors.visited.fill,
                hoverColor: colors.visited.hover,
                url: url
              });
            }
          }
        });
        
        polygonSeries.data.setAll(mapData);
        showStatus("✅ 地圖準備完成！");
        
        setTimeout(() => {
          debugDiv.style.opacity = "0";
        }, 3000);

      } catch (e) {
        console.error(e);
        if (window.location.protocol === 'file:') {
          showError("讀取失敗：請勿直接開啟檔案 (file://)，請使用 Live Server。");
        } else {
          showError("資料讀取失敗：" + e.message);
        }
      }
    }

    loadMapData();

    // 7. 控制項
    var zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
    
    // 重置按鈕
    var homeButton = chart.children.push(am5.Button.new(root, {
      paddingTop: 10, paddingBottom: 10, x: am5.p100, y: 0, centerX: am5.p100, dx: -20, dy: 20,
      label: am5.Label.new(root, { 
        text: "↺ 回到初始狀態", 
        fill: am5.color(0xffffff),
        fontSize: 14,
        fontWeight: "bold"
      }),
      background: am5.RoundedRectangle.new(root, { fill: am5.color(0x546E7A), fillOpacity: 0.8 }),
      cursorOverStyle: "pointer"
    }));
    
    // 重置功能 (Reload)
    homeButton.events.on("click", function() {
      showStatus("正在重新載入...");
      window.location.reload();
    });

  });
</script>

</body>
</html>
